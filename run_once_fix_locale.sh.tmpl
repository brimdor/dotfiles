#!/bin/sh
set -e

if [ "{{ .chezmoi.os }}" != "linux" ]; then
  exit 0
fi

current_locale=$(locale | grep '^LANG=' | cut -d= -f2)

if echo "$current_locale" | grep -q 'UTF-8'; then
  echo "[fix-locale] UTF-8 locale already set: $current_locale"
  exit 0
fi

echo "[fix-locale] Detected non-UTF8 locale: $current_locale"

distro_id=$(grep '^ID=' /etc/os-release | cut -d= -f2 | tr -d '"')

case "$distro_id" in
  ubuntu|debian)
    echo "[fix-locale] Applying locale fix for $distro_id"
    sudo locale-gen en_US.UTF-8
    echo 'LANG=en_US.UTF-8' | sudo tee /etc/default/locale
    sudo update-locale LANG=en_US.UTF-8
    ;;
  arch)
    echo "[fix-locale] Arch system â€” should be fine, skipping."
    ;;
  *)
    echo "[fix-locale] Unknown Linux distro ($distro_id). Skipping locale fix."
    ;;
esac