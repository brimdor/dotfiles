#!/usr/bin/env bash
# chezmoi:template
# chezmoi:chmod=755
set -Eeuo pipefail

log() { printf '[chezmoi] %s\n' "$*"; }

##############################################################################
# 0. Locate the playbook tree
##############################################################################
# The script ends up at   $HOME/apply_ansible_playbook.sh
# Your playbooks live at  $HOME/playbooks
SCRIPT_DIR="$HOME"                     # because this script lives in $HOME
PLAYBOOK_DIR="${SCRIPT_DIR}/playbooks"
PLAYBOOK_FILE="${PLAYBOOK_DIR}/bootstrap.yml"
ANSIBLE_CFG="${PLAYBOOK_DIR}/ansible.cfg"

##############################################################################
# 1. Sanity checks
##############################################################################
log "Checking prerequisites …"

if ! command -v ansible-playbook &>/dev/null; then
  log "Ansible is not installed. Aborting."
  exit 1
fi

if [[ ! -f $PLAYBOOK_FILE ]]; then
  log "Playbook file not found at $PLAYBOOK_FILE"
  exit 1
fi

##############################################################################
# 2. Pre-warm sudo (optional)
##############################################################################
log "Pre-warming sudo (you may be prompted once) …"
sudo -v
sudo true

##############################################################################
# 3. Run the playbook
##############################################################################
log "Running Ansible playbook …"

export ANSIBLE_CONFIG="$ANSIBLE_CFG"
pushd "$PLAYBOOK_DIR" >/dev/null

ansible-playbook "$PLAYBOOK_FILE" -i localhost, --diff

popd >/dev/null
log "Playbook completed successfully."