#!/bin/bash
{{ if eq .osid "linux-ubuntu" }}

set -euo pipefail

echo "[chezmoi] Adding external repositories for missing packages..."

# GitHub CLI
if ! command -v gh &>/dev/null; then
  type -p curl >/dev/null || sudo apt install curl -y
  curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
  sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" |
    sudo tee /etc/apt/sources.list.d/github-cli.list >/dev/null
fi

# HashiCorp (Terraform)
if ! command -v terraform &>/dev/null; then
  curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
  echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" |
    sudo tee /etc/apt/sources.list.d/hashicorp.list
fi

# Kubernetes CLI
if ! command -v kubectl &>/dev/null; then
  sudo apt-get update
  sudo apt-get install -y apt-transport-https
  curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
  echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" |
    sudo tee /etc/apt/sources.list.d/kubernetes.list
fi

# Zoxide
if ! command -v zoxide &>/dev/null; then
  curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
fi

echo "[chezmoi] Updating apt and installing all packages..."

sudo apt update
sudo apt install -y \
  docker.io \
  docker-compose \
  git \
  gh \
  curl \
  unzip \
  gnupg \
  lsb-release \
  zsh \
  ansible \
  terraform \
  python3-pip \
  netcat \
  kubectl \
  zoxide

# Enable + start Docker
sudo systemctl enable docker
sudo systemctl start docker

# Add current user to docker group
if ! groups $USER | grep -qw docker; then
  echo "[chezmoi] Adding $USER to docker group..."
  sudo usermod -aG docker "$USER"
  echo "[chezmoi] Docker group updated. You'll need to log out and back in for it to take effect."
fi

# Confirm docker installed
if command -v docker &>/dev/null; then
  echo "[chezmoi] Docker installed successfully."
else
  echo "[chezmoi] Docker installation failed."
fi

# Confirm kubectl installed
if command -v kubectl &>/dev/null; then
  echo "[chezmoi] kubectl installed successfully."
else
  echo "[chezmoi] kubectl installation failed or version not available."
fi

{{ end }}