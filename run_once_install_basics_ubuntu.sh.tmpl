#!/bin/bash
{{ if eq .osid "linux-ubuntu" }}

set -euo pipefail

echo "[chezmoi] Adding external repositories for missing packages..."

# Terraform (HashiCorp APT repo)
if ! command -v terraform &>/dev/null; then
  echo "[chezmoi] Adding HashiCorp APT repo for Terraform..."
  wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
fi

# kubectl
if ! command -v kubectl &>/dev/null; then
  echo "[chezmoi] Adding Kubernetes APT repo for kubectl..."
  sudo apt-get install -y apt-transport-https ca-certificates curl gnupg
  sudo mkdir -p -m 755 /etc/apt/keyrings
  curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  sudo chmod 644 /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
  sudo chmod 644 /etc/apt/sources.list.d/kubernetes.list
fi

# GitHub CLI (gh)
if ! command -v gh &>/dev/null; then
  echo "[chezmoi] Adding GitHub CLI APT repo..."
  curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg |
    sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
  sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" |
    sudo tee /etc/apt/sources.list.d/github-cli.list >/dev/null
fi

# Zoxide via script
if ! command -v zoxide &>/dev/null; then
  echo "[chezmoi] Installing zoxide via script..."
  curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
fi

echo "[chezmoi] Updating apt and installing all packages..."

sudo apt update
sudo apt install -y \
  docker.io \
  docker-compose \
  git \
  gh \
  curl \
  unzip \
  gnupg \
  lsb-release \
  zsh \
  ansible \
  terraform \
  python3-pip \
  netcat \
  kubectl \
  fzf \
  jq

# Enable + start Docker
sudo systemctl enable docker
sudo systemctl start docker

# Add current user to docker group
if ! groups $USER | grep -qw docker; then
  echo "[chezmoi] Adding $USER to docker group..."
  sudo usermod -aG docker "$USER"
  echo "[chezmoi] Docker group updated. You'll need to log out and back in for it to take effect."
fi

# Confirm docker installed
if command -v docker &>/dev/null; then
  echo "[chezmoi] Docker installed successfully."
else
  echo "[chezmoi] Docker installation failed."
fi

# Confirm kubectl installed
if command -v kubectl &>/dev/null; then
  echo "[chezmoi] kubectl installed successfully."
else
  echo "[chezmoi] kubectl installation failed or version not available."
fi

if command -v gh &>/dev/null; then
  if ! gh extension list | grep -q gh-copilot; then
    echo "[chezmoi] Installing GitHub Copilot CLI extension..."
    gh extension install github/gh-copilot
  fi
fi

{{ end }}